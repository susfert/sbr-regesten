\section{Extraction Process: Index}
\label{sec:index}

\emph{Author: Susanne Fertmann} \\

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.3]{img/index-examples}
  \caption{Examples for index entries taken from the Sbr-Regesten}
  \label{fig:index-examples}
\end{figure}
The index is a manually build list of entities that appear in the regests. It is the last part of the Sbr-Regesten and is 277 pages long. Figure~\ref{fig:index-examples} shows typical index entries taken from the Sbr-Regesten. The index entries differ from each other, but can roughly be divided into the following five groups: \textit{locations, landmarks, persons, families} and \textit{persongroups}. In total, there are 1035 index entries (see Figure~\ref{fig:type-table} for the distribution of groups). 

\begin{figure}[h]
\centering
\begin{tabular}{|l|c|}
\hline
Type of index entry & Number of entries  \\
\hline
Location            & 550 \\
Landmark            & 22  \\
Person              & 103 \\
Persongroup         & 46  \\
Family              & 313 \\
Other               & 1   \\
\hline
sum         & 1035\\
\hline
\end{tabular} 
\caption{Distribution of index entries}
\label{fig:type-table}
\end{figure}

\subsection{Index Entries}
An index entry can intuitively be divided into two parts, which we name \textit{header} and \textit{body}. The header gives more details about the entity, e.g. where a location is located, what profession a person has or in which regest to find the entity. The body gives a list of concepts/entities which are in some (sometimes specified) relation to the index entity. For example \textit{Boos von Waldeck} (see Figure~\ref{fig:index-examples}) would have the header \textit{Boos von Waldeck, Familie von 1473-03-19}. The remaining part of the index entry would be the body.

Irrespective of the group they belong to, index entries have some elements in common. Each index entry starts with its name, which is written in bold. The name might be followed by alternative or additional names. These are usually written in italics (which indicates that they are original text) and in parenthesis right after the name. The header of index entries usually ends with a set of numbers in the form of dates, which refer to the particular regests, where this entity is named. Right after these regest-references, there might appear references to other index entities. They start with the word \textit{siehe} (\textit{see}).

The body of an index entry is a list of concepts, which are related to the entity. For example \textit{Karl} stands in some relation to the family \textit{Boos von Waldeck}, namely he is a member of it. There exist different layers of such related concepts. If \textit{Karl} had a son for example, he could appear indented below \textit{Karl}. But apparently, a concept on the third level must not obligatorily be in relation with the one the first level. The house where Karl lived could appear below \textit{Karl} as well, although it is not directly related to the family. Often, the authors manually introduced a level between the index entity and the actual body-entities/concepts in order to group the items. For example \textit{Einwohner} or \textit{Güter}, below which there can be found a list of inhabitants/goods which in the regests appeared in relation with the index entity. Each concept might be followed by a set of numbers, which refers the reader to the regest in which the concept was named.

Apart from these commonalities, the headers and bodies are distinct for the different groups. The following sections describe the distinctive parts each of the five groups. 

\begin{figure}[h]
\centering
\begin{tabular}{|l|p{10cm}|}
\hline
\textbf{Group}        & \textbf{Possible types}  \\
\hline
location types & Dorf, Stadt, Stadtteil, Burgsiedlung, Burg,  ehem. Burg, Hofgut, Hof, Ort, Örtlichkeit, Gemeinde, Kloster,   Abtei, Schloss, Herrschaft, Herzogtum, Hzgt., Grafschaft,    Gft., Fürstentum, Kgr., Deutschordenskommende, Bistum,     Vogtei, Regierungssitz, Hochstift, Pfarrei, Erzstift, Erzbistum, Dekanat, Domstift, Reichsland, Deutschordensballei, Wasserburg, Mühle, Zisterzienserabtei, Region, Deutschordenshaus \\
\hline
landmark types & Berg, Gau, Talschaft, Bach, Tal, Landschaft, Au, Waldung, Wald, Gemeindewald \\
\hline
persongroups   & Notare, Grafen, Markgrafen, Herzöge, Bischöfe, Edelknechte, Herrn von, Herren, Fürsten, Personen, Könige, Ritter von, Einwohner, Päpste, Wildgrafen, Dominikaner \\
\hline
\end{tabular} 
\caption{Types for locations, landmarks and persongroups found in the index}
\label{fig:location-list}
\end{figure}

\paragraph{Locations}
The locations found in the index are geographical or political. They might also be buildings. Among them are towns, castles, parishes, kingdoms or mills. A full list of the types of locations found in the index can be found in Figure~\ref{fig:location-list}. In the index entry, the type of location is usually specified right after the name or eventual additional names. It is often followed by district (Gemeinde, Stadt, Stadtverband, Kreis), region (Province, Bundesland or Departement) and/or country. Most of the locations are in Germany. The country is only specified, when the location is not in Germany. Sometimes additional descriptions of where to find the location can be found right after the type name (e.g. \textit{Dorf im Köllertal}, \textit{Hof bei St. Ingbert}). Locations also specify if a location is no longer inhabited. Entries of such abandoned villages (\textit{Wüstungen}) contain references where to find them in Staerk's catalogue\footnote{Dieter Staerk, Die Wüstungen des Saarlandes, Minerva-Verlag, Saarbrücken, 1974.}). %See figure~\ref{fig:location-example} for sample entries.

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.45]{img/location-example}
  \caption{Examples for location index entries taken from the Sbr-Regesten}
  \label{fig:location-example}
\end{figure}

\paragraph{Landmarks}
Landmarks (\textit{Flurnamen}) are geographical units as forests, mountains, valleys. For the whole list of landmarks found in the index, see Figure~\ref{fig:location-list}. Landmarks do not provide any additional unique information.% See figure~\ref{fig:landmark-example} for sample entries.

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.45]{img/landmark-example}
  \caption{Examples for landmark index entries taken from the Sbr-Regesten}
  \label{fig:landmark-example}
\end{figure}

\paragraph{Persons}
Person-headers may contain forenames, surnames, maiden names any generational names (as \textit{Senior, the first, II.}). Additionally they can specify the role or occupation of the person, biographical information such as date of birth or date of the beginning the role and relations to other persons (e.g. \textit{married with, son of}).% See figure~\ref{fig:person-example} for sample entries.
\begin{figure}[h]
  \centering
  \includegraphics[scale=0.45]{img/person-example}
  \caption{Examples for person index entries taken from the Sbr-Regesten}
  \label{fig:person-example}
\end{figure}

\paragraph{Families}
Family-headers have no special elements. But their body can be defined more precisely. Family-bodies do not only represent a list of related entities/concepts, but they are a list of the members of the family. After each of them, the regest where it appeared might be specified. Below each family member (at the next level) there might appear concepts related to that specific member. This might again be a family member but not necessarily.
%%See figure~\ref{fig:family-example} for sample entries.

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.45]{img/family-example}
  \caption{Examples for family index entries taken from the Sbr-Regesten}
  \label{fig:family-example}
\end{figure}

\paragraph{Persongroups}
Persongroups are index entries that contain a group of persons. For example, there is a list for popes, for inhabitants of Saarbrücken, bishops etc. The complete list is shown in Figure~\ref{fig:location-list}. The group name is specified in the header. Similar to the families, the header does not contain any specific elements, whereas the body is a list of concepts which can be specified more concretely. In the case of persongroups, each concept on the first level of the body is a person and member of the group. %See figure~\ref{fig:persongroup-example} for sample entries.

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.45]{img/persongroup-example}
  \caption{Examples for persongroup index entries taken from the Sbr-Regesten}
  \label{fig:persongroup-example}
\end{figure}

\paragraph{Others}
\label{sec:other-index-entry}
Only one index entry is very unusual and does not fit in any of the proposed groups. It is the entry \textit{Saarbrücken, Gliederung}, which shows an overview over the \textit{Saarbrücken} entry (see Figure~\ref{fig:sb-gliederung}). The \textit{Saarbrücken} entry is the largest index entry with almost 100 pages. It is therefore split up into seven entries. \textit{Saarbrücken, Gliederung} gives an overview over these entries.

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.6]{img/sb-gliederung}
  \caption{The index entry \textit{Saarbrücken, Gliederung}}
  \label{fig:sb-gliederung}
\end{figure}


\subsection{XML Schema for the Index}
\label{sec:index-schema}
One of the main contributions of the Sbr-Regesten project was to create an XML schema for the Sbr-Regesten. The schema can be found in the file \texttt{sbr-regesten/regesten-schemas/sbr-regesten.xsd}.
It was as far as it was applicable designed to comply with the \href{http://www.tei-c.org/Guidelines/} {TEI Guidelines}\footnote{\href{http://www.tei-c.org/Guidelines/P5/index.xml}{TEI P5}: Guidelines for Electronic Text Encoding and Interchange by the TEI Consortium, Version 2.0.2, 2012}. This section describes the schema for the index.

The index consists of an \texttt{index-info}, which contains general information about the index, followed by an unrestricted number of \texttt{items}. Each \texttt{item} represents an index entry and is either a location, a person, a landmark, a family or a persongroup. The schema covers each of the groups respectively.

Each index item requires the following attributes: 
\begin{itemize}
\item \texttt{id}: a unique id (e.g. item\_381)
\item \texttt{type}: location, landmark, person, family or persongroup
\item \texttt{value}: the name of the item (printed in bold in the printed Sbr-Regesten)
\end{itemize}


An index \texttt{item} consists of an \texttt{item-header} and does usually also have an \texttt{item-body}. Both are abstract elements, which are substituted by the respective header and body types. This decision was made in order to have only one type of items with consecutive IDs, although the headers and bodies highly vary depending on their type.

Irrespective its type, a header usually ends with the element \texttt{mentioned-in}, which might only be followed by \texttt{index-refs}. \texttt{Mentioned-in} is of type \texttt{mentionings} and contains a sequence of references to the regests (\texttt{reg-ref}). The attribute \texttt{regest} specifies the id from the regest it refers to. \texttt{Index-refs} contains a sequence of references to other index entries (\texttt{index-ref}). The attribute \texttt{itemid} contains the id from the index item it refers to. 

The next sections will describe in more detail the elements that items have depending on their type. They will also provide a XML example for each header and body type.

\subsubsection{Headers}
\label{header-xml}

\paragraph{Location-Header}
\label{sec:location-header}
Figure~\ref{fig:location-header-xml} and \ref{fig:location-wuest-xml} show examples for location headers. Location headers contain the element \texttt{placeName}, which corresponds mostly to TEI's \texttt{placeName}. Figure~\ref{fig:placeName} shows an example for a comparison of the two. The Sbr-Regesten schema adopts TEI's \texttt{settlement}, \texttt{district}, \texttt{region} and \texttt{country}. It introduces two new attributes for the \texttt{settlement} element, aside from \texttt{type}. It gets the additional attributes \texttt{abandoned-village} and \texttt{av-ref} to encode information about abandoned villages (\textit{Wüstungen}). \texttt{Abandoned-village} is an obligatory attribute, which denotes whether the settlement is an abandoned village. If that is the case, the optional attribute \texttt{av-ref} encodes a reference to the catalogue of Staerk\footnote{Dieter Staerk, Die Wüstungen des Saarlandes, Minerva-Verlag, Saarbrücken, 1974.}. Region types may be \texttt{Bundesland} (if located in Germany), \texttt{Departement} (France) or \texttt{Province} (Belgium). \texttt{Country} has no attributes. The TEI guidelines define a \texttt{district} as “any kind of subdivision of a settlement, such as a parish, ward, or other administrative or geographic unit.”\footnote{TEI P5: Guidelines for Electronic Text Encoding and Interchange by the TEI Consortium, Version 2.0.2, 2012} In contrast, in our index-locations a \texttt{district} is any administrative unit below a \texttt{region} (\textit{Kreis, Gemeinde, Stadtverband}).

\begin{figure}[H]
\centering
\begin{verbatim}
<placeName>
    <settlement type="city">Rochester</settlement>,
    <region type="state">New York</region>
</placeName>

<placeName>
    <settlement type="Stadt" abandoned-village="false">Saarbrücken</settlement>,
    <region type="Bundesland">SL</region>
</placeName>
\end{verbatim}
\caption{\texttt{placeName} in TEI vs. \texttt{placeName} in the Sbr-Regesten schema}
\label{fig:placeName}
\end{figure}

Additional to \texttt{placeName}, the index schema for locations introduces two elements: \texttt{addNames} and \texttt{reference-point}. \texttt{AddNames} contains a list of additional names of the location, each of them tagged as \texttt{addName}. \texttt{Reference-point} includes further information that is not covered by \texttt{district, region} or \texttt{country}. It specifies closer where to find the location, e.g. \textit{Im Köllertal, bei St. Ingbert} (\textit{in the Köllertal, near St. Ingbert}). All elements in \texttt{placeName} are optional (even settlement, as \texttt{placeName} also occurs in family headers, where locations are given, without their names being explicitly specified.)   

\begin{figure}[H]
\centering
\begin{verbatim}
<location-header>
   <placeName>
      <settlement type="Dorf" abandoned-village="false">Frauenberg</settlement>
      <addNames> (
         <addName>Frauwenberg</addName>)
      </addNames>, Dorf (
      <region type="Departement">Dep. Moselle</region>, 
      <country>F</country>) 
   </placeName>
   <mentioned-in>
      <reg-ref regest="regest_235">1452-12-26</reg-ref>, 
      <reg-ref regest="regest_984">1459-02-19</reg-ref>
   </mentioned-in> siehe 
   <index-refs>
      <index-ref itemid="item_534">Lenterdingen</index-ref>,
      <index-ref itemid="item_956">Volkersweiler</index-ref>
   </index-refs>
</location-header>
\end{verbatim}
\caption{Sample \texttt{location-header} XML}
\label{fig:location-header-xml}
\end{figure}

\begin{figure}[H]
\centering
\begin{verbatim}
<location-header>
   <placeName>
      <settlement type="Dorf" abandoned-village="true" aV-ref="Staerk, Wüstungen Nr. 19">
         Arschofen</settlement>
      <ddNames> (
         <addName>Arßhoffen</addName>)
      </addNames>, Dorf 
      <reference-point>im Köllertal</reference-point> (Wüstung, 
      <district>Gde. Gersweiler, Stadtverband Sb.</district>, 
      <region type="Bundesland">SL</region>; Staerk, Wüstungen Nr. 19) 
   </placeName>
</location-header>
\end{verbatim}
\caption{Sample \texttt{location-header} XML of an abandoned village \textit{Wüstung}}
\label{fig:location-wuest-xml}
\end{figure}


\paragraph{Landmark-Header}
Figure~\ref{fig:landmark-header-xml} shows an example for a \texttt{landmark-header}. Landmark-headers consist of the elements \texttt{geogName}, \texttt{mentioned-in} and \texttt{index-refs}. The element \texttt{geogName} captures the same concept as TEI's \texttt{geogName}. But it is differently realized. Namely, it contains exactly the two elements \texttt{name} and \texttt{addNames} (additional names).

\begin{figure}[H]
\centering
\begin{verbatim}
<landmark-header>
   <geogName type="Fluss">
      <name>Rossel</name>
         <addNames>(
         <addName>Russel</addName>)
      /addNames>
   </geogName>, Fluss 
</landmark-header>
\end{verbatim}
\caption{Sample for \texttt{landmark-header}}
\label{fig:landmark-header-xml}
\end{figure}

\paragraph{Person-Header}
\label{sec:person-header}
Figure~\ref{fig:person-header-xml} shows an example for a \texttt{person-header}. Person headers provide the element \texttt{person}. Person consists of \texttt{persName} and \texttt{description}. \texttt{PersName} is very close to TEI's \texttt{persName}. It contains (optional) \texttt{forename}, \texttt{surname}, \texttt{genName} (generational name, such as \textit{Senior, the first, II.}, see TEI Guidelines) and \texttt{roleName} (name of the role or official position of the person, such as \textit{Fürst, Herzog, Papst}, see TEI Guidelines.). The only addition to TEI in \texttt{persName} is \texttt{maidenname} (maiden name). Also here we do not have a single additional name (\texttt{addName}), but the element \texttt{addNames}, which contains a list of \texttt{addName} elements. It is also important to know that a \texttt{person} has not only an item id (as the other headers do), but also an id that refers to the person itself. This is due to the fact, that the \texttt{person} element is also used in the \texttt{listing-body}. A person therefore has two attributes: \texttt{id} and \texttt{itemid}.
The other element of \texttt{person}, \texttt{description}, provides additional information about the person, such as occupation, relation to other persons (\textit{married to, son of,} etc.). It is of type \texttt{content}, which means, that it can contain \texttt{quote} elements, if there is original text in the \texttt{description}.

\begin{figure}[H]
\centering
\begin{verbatim}
<person-header>
   <person id="person_412">
      <persName>
         <forename>Johann</forename> 
         <genName>I.</genName>, 
         <roleName>Graf</roleName>
      </persName>
     <description> von Saarbrücken-Commercy (1307-1341), 
                    oo Mathilde von Apremont    </description>
   </person>
   <mentioned-in>
      <reg-ref regest="regest_543">1310</reg-ref>, 
      <reg-ref regest="regest_1353">1310-10-21</reg-ref>, 
   </mentioned-in>
</person-header>
\end{verbatim}
\caption{Sample for \texttt{person-header}}
\label{fig:person-header-xml}
\end{figure}

\paragraph{Family-Header}
Figure~\ref{fig:family-header-xml} displays an example for a \texttt{family-header}. Family headers consist of the elements \texttt{family-name}, \texttt{location}, \texttt{mentioned-in} and \texttt{index-refs}. \texttt{Family-name} consists of name and \texttt{addNames} (additional names). \texttt{Location} is of type \texttt{placeName}, which is the same type that \texttt{location-headers} have. See Section \ref{sec:location-header} \textit{location-header} for more details.

\begin{figure}[H]
\centering
\begin{verbatim}
<family-header>
  <family-name>
     <name>Brandscheid</name>
     <addNames>
        <addName>Brandscheidt<addName>       
     </addNames>
  </family-name> (
  <location>
     <district>Kr. Bitburg-Prüm</district>, 
     <region type="Bundesland">RLP</region>
  </location>), Familie von 
</family-header>
\end{verbatim}
\caption{Sample for \texttt{family-header}}
\label{fig:family-header-xml}
\end{figure}

\paragraph{Persongroup-Header}
Figure~\ref{fig:persongroup-header-xml} shows an example for a \texttt{persongroup-header}. Persongroup headers consist of the elements \texttt{group-name}, \texttt{mentioned-in} and \texttt{index-refs}. \texttt{Group-name} contains the name of the persongroup.

\begin{figure}[H]
\centering
\begin{verbatim}
<persongroup-header>
   <group-name>Notare </group-name>
</persongroup-header>
\end{verbatim}
\caption{Sample for \texttt{persongroup-header}}
\label{fig:persongroup-header-xml}
\end{figure}

\subsubsection{Bodies}
There are two different types of bodies: \texttt{Concept-body} and \texttt{listing-body}.

\paragraph{Concept-body}
A concept-body contains the element \texttt{related-concepts}. \texttt{related-concepts}, in turn, consists of an unrestricted number of \texttt{concepts} and \texttt{persons}\footnote{Note, that currently only concepts are extracted.}. A concept provides a \texttt{name}, a \texttt{description} and \texttt{mentioned-in}. \texttt{Name} contains the name of the concept and \texttt{description} any additional information provided. Additionally, a \texttt{concept} can recursively contain an element \texttt{related-concepts}. For the description of a \texttt{person}, see Section \ref{sec:person-header} \textit{Person-Header}.


\begin{figure}[H]
\centering
\begin{verbatim}
<concept-body>
   <related-concepts>
      <concept>
         <name> Einwohner </name>
         <related-concepts> -
            <concept>
               <name> Hans gen. Phennewert </name>
               <mentioned-in>
                  <reg-ref regest="regest_64">1455-11-24</reg-ref>
               </mentioned-in>
            </concept> -
            <concept>
               <name> Philipps Pfenwert von Hermanßhusen</name>
               <description>, Bürger zu Saarbrücken, oo Ursulla </description>
               <mentioned-in>
                  <reg-ref regest="regest_756">1510-11-09</reg-ref>, 
                  <reg-ref regest="regest_834">1521-12-24</reg-ref>
               </mentioned-in>
            </concept>
         </related-concepts>
      </concept>
      <concept>
         <name> Güter </name>
         <mentioned-in>
            <reg-ref regest="regest_43">1296-12-29</reg-ref>
         </mentioned-in>
      </concept>
   </related-concepts>
</concept-body>
\end{verbatim}
\caption{Sample for \texttt{concept-body}}
\label{fig:concept-body-xml}
\end{figure}

\paragraph{Listing-body}
Figure~\ref{fig:listing-body-xml} illustrates an example for a \texttt{listing-body}. A listing-body consists of the element \texttt{members}. \texttt{Members} consists of a sequence of \texttt{persons}, which have the type as the persons appearing in a \texttt{person-header} (see Section sec:person-header \textit{Person-Header}). Each \texttt{person} can have a \texttt{related-concepts} element, which recursively can contain related concepts again, as in a concept-body.
That means, that in a \texttt{persongroup} or \texttt{family}, the first layer displays members of that family or group. The concepts on deeper levels might also be family or group members but not obligatory. Therefore they are not modelled as members on their own, but as related-concepts of that member.

\begin{figure}[H]
\centering
\begin{verbatim}
<listing-body>
  <members>
     <person id="person_89">
        <persName>
           <forename> Dietrich </forename>gen.
           <addNames>
              <addName> Gebürghin </addName>
           </addNames>
        </persName>
        <mentioned-in>
           <reg-ref regest="regest_823">1460-12-01</reg-ref>
        </mentioned-in>
        <related-concepts> -
           <concept>
              <name> Knecht Peter </name>
              <mentioned-in>
                 <reg-ref regest="regest_823">1460-12-01</reg-ref>
              </mentioned-in>
           </concept>
        </related-concepts>
     </person>
     <person id="person_90">
        <persName>
           <forename> Jakob von Brandscheid</forename>
        </persName>
        <description>, Amtmann zu Saargemünd </description>
        <mentioned-in>
           <reg-ref regest="regest_934">1519-03-23</reg-ref>
        </mentioned-in>
     </person>
  </members>
</listing-body>
\end{verbatim}
\caption{Sample for \texttt{listing-body}}
\label{fig:listing-body-xml}
\end{figure}


\subsection{Index Extraction}
In order to convert the Sbr-Regesten index into an XML representation, relevant pieces of information have to be extracted from the HTML file and tagged according to the schema. Additionally, the index entries are written into the database \texttt{sbr-regesten.db}. This chapter will describe in more detail how the XML for the index is extracted. Generally, the index suffers many inconsistencies due to its manual construction. That complicates the index extraction.


\begin{figure}[h]
  \centering
  \includegraphics[scale=0.5]{img/index-extractor}
  \caption{Simplified architecture of \texttt{index\_extractor.py}}
  \label{fig:index-extractor}
\end{figure}

Figure~\ref{fig:index-extractor} shows the basic architecture of the module (\texttt{index\_extractor.py}), which is responsible for the index extraction. Note that it does not show any classes, but is aimed to illustrate the logical structure/workflow of \texttt{index\_extractor.py} to demonstrate its functionality. In short, the \texttt{index\_extractor} module finds the index in the HTML and extracts single index items. These are post-processed before yielding the final XML for the index entries and writing them form the XML file into the database.

The \texttt{index\_extractor.py} module is divided into three modules (stored in in \texttt{sbr-regesten/\-extraction/\-index\_utils}):

\begin{itemize}
\item \texttt{index\_to\_xml.py} extracts the index from the HTML file and converts it into an almost complete XML
\item \texttt{index\_xml\_postprocess.py} post-processes the XML solving the references to other index entries
\item \texttt{index\_to\_db.py} extracts the index items from the XML and writes them into the database
\end{itemize}

The index extraction is implemented in two separate stages which convert the index into XML and store it in the database, respectively. This has two reasons: it structures the module and it allows a manual correction of the extracted XML before before the items are added to the database.

\subsubsection{Extracting, Classifying and Parsing Index Items}
The module \texttt{index\_to\_xml.py} uses the python package \href{http://www.crummy.com/software/BeautifulSoup/bs4/doc/} {\textit{BeautifulSoup}} to process the HTML file and convert it into its XML representation. One problem that arose was that due to the maximum recursion limit the very deep structured index entry \textit{Saarbrücken, Burgsiedlung/Dorf/Stadt} could not be processed. Therefore the recursion limit had to be increased\footnote{This seems to be a common problem when using BeautifulSoup. See this  \href{http://blog.pablohoffman.com/maximum-recursion-limit-in-python}{blog entry on maximum-recursion-limit-in-python}.}.

Figure~\ref{fig:index-to-xml} shows the call graph for the main function of \texttt{index\_to\_xml.py}. It is pruned excluding the preprocessing steps and the solving of underspecified index items (see Section \ref{sec:classifier} \textit{ItemClassifier}).

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.37]{img/index-to-xml}
  \caption{Pruned call graph of \texttt{index\_to\_xml.py}}.
  \label{fig:index-to-xml}
\end{figure}

\paragraph{ItemExtractor}
The ItemExtractor (implemented by the function \texttt{extract\_items}) reads the HTML source and converts it into a \texttt{BeautifulSoup} instance. The detection of the individual index items is very straightforward, as the HTML provides tags for paragraphs (\texttt{<p>}). Each index item is a paragraph. In order to find the beginning of the index, the paragraph starting with the keyword \textit{Index} is searched. Once it is found, the ItemExtractor tags the next non-empty paragraph as \texttt{<index-info>}. Each of the following non-empty paragraphs is recognized as index \texttt{item}. It obtains an id and is preprocessed. The preprocessing step deletes tags that are irrelevant from the HTML and overcomes some irregularities. An instance of \texttt{Index Item} is created, which divides the HTML paragraph into a header and body. The ItemExtractor finishes processing the paragraphs when reading more than ten empty paragraphs in a row. In that case the index section is assumed to be finished. The end of the index can not be identified directly via a keyword as for the beginning of the index and as in the extraction of the other parts of the books because the index is the last part of the book, only followed by the footnotes (in the HTML file). Finally, all extracted item objects are stored in a list and are in the next step given to the ItemClassifier.

\paragraph{ItemClassifier}
\label{sec:classifier}
The ItemClassifier is implemented by the function \texttt{classify\_and\_parse}. It classifies the items and forwards them to their corresponding parser functions for processing. The ItemClassifier obtains the list of index items and searches the header of each item for a set of keys and regular expressions. These were retrieved by a manual bootstrapping process and are displayed in Figure~\ref{fig:regex} \footnote{Note, that the order of the keys and the matches are relevant, as some are more reliable than others.}. According to the keys, the ItemClassifier decides for each item whether it belongs to the group \textit{location, landmark, person, family, persongroup} or \textit{siehe}. It forwards the item to the corresponding parser (\texttt{loc\_to\_XML, land\_to\_XML, pers\_to\_XML, fam\_to\_XML} or \texttt{persgr\_to\_XML} respectively). The items stored in the \textit{siehe} list contain no direct information about the group they belong to. But they contain references to other index entries. Assuming that referring and referenced entry have the same type, they are forwarded to the corresponding parser after having solved the reference. Items that do not contain any of the keywords are stored in the list \textit{unclassified} and are not further processed. This is the case for the entry \textit{Saarbrücken, Gliederung} as this is a rather unusual entry (see Section~\ref{sec:other-index-entry}).

\begin{figure}
\centering
\begin{verbatim}
famMatch = re.search('[Ff]amilie|Adelsgeschlecht', header)

locMatch = re.search('[Ss]tadt,|Stadtteil|Dorf|Burg |Hof |Hofgut|'\
                     'Gemeinde |Ort |.rtlichkeit |Kloster|Schloss|'\
                     'Herrschaft|Gft\.|Kgr\.|Region|Gebiet|Abtei|'\
                     'Land |Kgr\.|Herzogtum|Hzgt\.|[Gg]rafschaft|'\
                     'F.rstentum|Deutschordenskommende|RLP|Gde\.|'\
                     'Bistum|Vogtei|Regierungssitz|Hochstift|'\
                     'Pfarrei|W.stung|F\)|Erzstift|, Erzbistum|'\
                     'Dekanat|Domstift|Reichsland|Deutschordensballei'\
                     '|M.hle|Wallfahrt|Land |Reise|lothr. Amt|'\
                     'Deutschordenshaus|[Ss]tadt (?!S)', header)

grpMatch = re.search('Notare|, Grafen|, Markgrafen|[Hh]erz.ge|'\
                     '[Bb]isch.fe|Edelknechte|Herrn von|[Ff].rsten|'\
                     'Personen|K.nige|Ritter von|Einwohner|P.pste|'\
                     'Wildgrafen|Herren|(?<!, )Dominikaner', header)

persMatch = re.search('Bischof|Pastor|Graf |Papst |II\.|I\.|III\.|'\
                      'IV\.|V\.|Hzg\.|Bf\.|Adliger|Herr |Frau |Kg\.|'\
                      'Elekt|meister|Ritter|, Schulthei.|, Herzogin|'\
                      'Amtmann|Lehensmann|Vetter von|Markgraf |'\
                      'Pfalzgraf|Ebf\.|, Herzog|, Dominikaner|Hans|'\
                      'Erzpriester|[dD]iakon|Provinzial|r.m\. K.nig|'\
                      'Kammermajor|Witwe|Junker|Stephan|Jacob|Klaus|'\
                      'Elisabeth|Fabricio|Nikolaus|Alheim|Gerbod', \
                      header)

landMatch = re.search('Fluss|Berg|gau[ ,]|Gau|Bach|Tal|Landschaft|'\
                      'Wald|Waldung|Gemeindewald|Au|furt|Engenberg', \
                      header)

\end{verbatim}
\caption{Regular expressions used to classify the index items}
\label{fig:regex}
\end{figure}


\paragraph{ItemParser}
When an item is classified it is passed to its corresponding ItemParser. There is an ItemParser for each of the five groups. It forwards the header to the specific header parser of its group and the body to one of the two body parsers. It then adds the parsed item to an itemList. The HeaderParsers return also the name of the index entry, which is taken as \texttt{value} attribute of \texttt{item}. For example, the LocationParser passes the header to the Location-Header-Parser, which returns an XML \texttt{location-header} and the name of the item. This name is taken as \texttt{value} attribute. The id obtained by the ItemExtractor is taken as \texttt{id} attribute and the \texttt{type} (in this case \texttt{location}) is added. The body is passed to the Concept-Body-Parser. The LandmarkParser, PersonParser, FamilyParser and PersongroupParser proceed analogously. The following two sections describe the parsers for the headers and the bodies.


\subsubsection{Header Parsers}
This section describes the five parser functions for the different item headers: \textit{Location-Header-Parser, Landmark-Header-Parser, Person-Header-Parser, Family-Header-Parser} and \textit{Persongroup-Header-Parser}. Functionalities that are used by several parsers are presented at the end of this section: references to the index, references to the regest and parsing of additional names.

\paragraph{Location-Header-Parser}
The parser for the location headers (\texttt{loc\_header\_to\_XML}) builds a \texttt{<location-header>}, which contains a \texttt{<placeName>}, which again includes a \texttt{<settlement>}. The latter gets the attributes \texttt{abandoned-village} and \texttt{av-ref}. The parser searches the header for the keyword \textit{W.stung} in order to decide whether the location is an abandoned village and assigns \texttt{abandoned village} the corresponding value (\texttt{true/false}). The regular expression 

\begin{verbatim}
Staerk, W.stungen Nr. [0-9]{1,2} 
\end{verbatim}

is used to extract the reference to Staerk's catalogue\footnote{Dieter Staerk, Die Wüstungen des Saarlandes, Minerva-Verlag, Saarbrücken, 1974.} \texttt{av-ref}. The name of the location is extracted from the HTML via the \texttt{<b>} tag and added to the \texttt{<settlement>} tag. The additional names are parsed by the AddNamesParser (see Section \ref{sec:addNames} \textit{Parsing of Additional Names}) exploiting existing parenthesis and \texttt{<i>} tags. From the rest of the HTML location-header, all HTML tags are deleted before the rest is processed. Then references to the regests and to other index entries are parsed by the respective parsing functions (see Section~\ref{sec:reg-refs} and \ref{sec:index-refs}). The remaining string is searched for the type of the settlement (for the whole list see Figure~\ref{fig:location-list}). If one of the keywords is found it is taken as value for the attribute \texttt{type} of \texttt{settlement}. The rest of the string is parsed by the function \texttt{parse\_place\_name} (see Section~\ref{sec:addNames}). Afterwards, the placeNameTag is added to the location-header, as well as the references to the regests and the references to the index. The header is now parsed.

\paragraph{Landmark-Header-Parser}
The Landmark-Header-Parser is implemented by the function \texttt{land\_to\_XML}. It builds a \texttt{BeautifulSoup} instance \texttt{<landmark-header>} and adds a \texttt{<geogName>} tag to it. The landmark's name is extracted via the \texttt{<b>} tags in the HTML and added to a \texttt{<name>} tag, which is appended to \texttt{geogName}. The remaining HTML is passed to the AddNameParser in order to extract additional names, possibly appearing in the beginning. The remaining part is flattened to a string, whose end is searched for index-refs and mentionings. The remaining middle part is thereafter searched for a set of keys for the type of landmark. See Figure~\ref{fig:location-list}. If none of the keys is found in the rest string, the name of the landmark is searched. This is because the type is often not explicitly specified if it is already contained in the name, e.g. \textit{Dirminger Tal, Ensdorfer Au}.

\paragraph{Person-Header-Parser}
The person headers are parsed by the function \texttt{pers\_header\_to\_XML}. It builds a \texttt{<person-header>} \texttt{BeautifulSoup} tag and adds a \texttt{<person>} tag to it. The latter obtains a continious id with the pattern \texttt{person\_[0-9]+}. A tag \texttt{<persName>} is added to the \texttt{person}. The \texttt{name} is extracted exploiting the \texttt{<b>} tags of the HTML. Thereafter, the HTML tags are aborted and index-refs and mentionings are extracted from the end of the remaining string (see Section~\ref{sec:index-refs} and \ref{sec:reg-refs}). The remaining middle part is then used to extract \texttt{forename, surname, genName and roleName}. For that purpose, a set of keywords is exploited (e.g. \textit{der Dritte, der Junge, Jr} for \texttt{genName} and \textit{Kaiser, Herzogin, Graf} for \texttt{roleName}). A list of forenames is provided by the file \texttt{sbr-regesten/resources/forenames.txt} which is imported at the beginning of \texttt{index\_to\_xml.py} and augmented during the extraction by the Listing-Body-Parser. A set of regular expressions describes possible combinations of these different names. The first matching rule is chosen and the item header tagged accordingly. The remaining part of the string is tagged as \texttt{<description>}. At the end the extracted index-refs and mentionings are added to the \texttt{<person-header>} tag.

\paragraph{Family-Header-Parser}
The headers of family items are parsed by the function \texttt{fam\_header\_to\_XML}. A \texttt{<family-header>} tag is created and a tag \texttt{<family-name>} is appended to it. The latter contains the name of the family extracted from the HTML via the \texttt{<b>} tags. Afterwards, the \texttt{<b>} tag is deleted and the rest of the HTML is searched for additional names. The rest of the HTML that does not contain any additional names is converted into a tag-less string. If this contains an opening parenthesis before the next word, the content of these parenthesis are detected to be a location, which is parsed by the placeName Parser (see Section~\ref{sec:addNames}), which also parses the corresponding part from the location headers. The part following the parenthesis (if there were such, elsewise, the whole remaining string) is searched for index-refs and mentionings.

\paragraph{Persongroup-Header-Parser}
The Parser for persongroup-headers is the least complex headerParser, due to the simplicity of the actual headers and the XML schema. A \texttt{<persongroup-header>} tag is created. The HTML-tags are deleted and index-refs and mentionings are found at the end of the string. The remaining part is tagged as \texttt{<group-name>}. \texttt{group-name, index-refs} and \texttt{mentionings} are added to \texttt{persongroup-header}.

\paragraph{References to the Index}
\label{sec:index-refs}
References to the index can be found at the very end of an index entry (regardless its type). They start with the keywords \textit{siehe} or \textit{siehe auch}, e.g. \textit{siehe Lenterdingen, Volkersweiler}. The function \texttt{find\_index\_refs} therefore recognizes strings starting with one of these keyword and ending with the end of the string as index-refs. As the references can not be solved at the time of extracting the index (references can refer to future index entries), they are not further processed, but only tagged with \texttt{<index-refs>}. The further division into the individual index references and their solving does not take place until the post-processing step (see Section~\ref{sec:postproc}).

\paragraph{References to the Regests}
\label{sec:reg-refs}
The references to the regests are given by the date of the regest, e.g. \textit{1377-03-08 (nach), 1065-04-03, 1277-07-02 (b)}. The are not exactly the same as the titles of the regests. They usually contain only the date plus the information that is crucial for disambiguation. But this does not seem to be very consistent. They may occur at the end of \texttt{related-concepts}, and at the end of each type of index-header, only possibly followed by references to the index (\texttt{index-refs}).
The function \texttt{parse\_mentionings} recognizes the references to the regests in a given string (by using a regular expression). It builds a \texttt{<mentioned-in>} tag. It starts form the end of the string and tries to find one reference after another. It tags it as \texttt{<reg-ref>} and adds as attribute \texttt{regest} the id of the regest it refers to. This part is carried out by the function \texttt{get\_regest\_ID}. Once the precedent part was not recognized as reference, \texttt{parse\_mentionings} finishes.


\paragraph{Parsing of Additional Names \texttt{(parse\_addnames)}}
\label{sec:addNames}
\texttt{parse\_addnames} obtains a flat HTML element and extracts additional names. Additional names are written in italics and in parenthesis. Therefore the parser looks for \texttt{<i>} tags surrounded by parenthesis. The string inside contains the additional names, which are separated by commas. Each is tagged with \texttt{<addName>} and added to a \texttt{<addNames>} tag.


\subsubsection{Body Parsers}
This section describes the two parser functions for index bodies \textit{Concept-Body-Parser} and \textit{Listing-Body-Parser}.

\paragraph{Concept-Body-Parser}
\label{sec:conc-body-parser}
The Concept-Body-Parser is implemented by the function \texttt{conc\_body\_to\_XML}. It splits the HTML item into lines, making use of the \texttt{<br>} tags. It created a \texttt{<concept-body>} tag, which contains \texttt{<related-concepts>} tag. Each non-indented HTML line is a \texttt{concept} and added to \texttt{<related-concepts>}. It is split into \texttt{name}, \texttt{description} and \texttt{mentionings}. \texttt{Mentionings} are extracted according to paragraph \ref{sec:reg-refs} \textit{References to the regests}. The remaining string is split at the first comma. The first part of the string will be the \texttt{name} of the concept and the second its \texttt{description}. The indented lines below a concept are added to a \texttt{related-concepts}. \texttt{related-concepts} again is split into concepts and processes recursively. \texttt{<name>}, \texttt{<description>}, \texttt{<mentionings>} and \texttt{<related-concepts>} are added to the \texttt{<concept>} tag.

\paragraph{Listing-Body-Parser}
The parser for listing bodies is implemented by the function \texttt{listing\_body\_to\_XML}. It builds a \texttt{<listing-body>} tag, which again contains a \texttt{<members>} tag. The Listing-Body-Parser splits the item HTML in lines exploiting the \texttt{<br>} tags. Each non-indented line is a person. A \texttt{<person>} tag is created which contains a \texttt{<persName>} tag. In almost all cases, the string of the person starts with its forename (especially in family-headers, where the surname is already given in the header). The Listing-Body-Parser therefore tags the first word in the person as \texttt{<forename>} and adds it to the \texttt{<persName>} tag. These forenames are additionally used to extend the forenames list (which is provided by \texttt{sbr-regesten/resources/forenames.txt} and used to find forenames in person headers). From the remaining string additional names (\texttt{addNames}) are parsed and added to \texttt{<persName>}. \texttt{<mentionings>} are extracted as described in Section~\ref{sec:reg-refs} \textit{References to regests}). The remaining part is tagged as \texttt{<description>}. The indented lines below a person-line are \texttt{related-concepts} of that person. The latter are parsed recursively using the same process as described in the paragraph above(\ref{sec:conc-body-parser}). \texttt{<persName>}, \texttt{<description>}, \texttt{<mentionings>} and \texttt{<related-concepts>} are added to the \texttt{<person>} tag.


\subsubsection{Post-Processing}

\paragraph{ItemPostprocessor}
\label{sec:postproc}
The post-processing step solves the references to other in index entries. This is only possible when the entire index is already parsed, as it searches all index items. The post-processing step is carried out by the module \texttt{index\_xml\_postprocess.py}. It takes the temporary file \texttt{index.xml} as input, which was produced by the module \texttt{index\_to\_xml.py} and deletes it afterwards. It builds a \texttt{BeautifulSoup} instance out of the index XML, which is split into single index items. It detects the yet unsolved \texttt{<reg-refs>} tags and splits the contained string into the single references (using comma as separator). The references are solved by matching the string to the \texttt{value} of each index item. If the reference can be solved, a \texttt{<reg-ref>} tag is added to \texttt{<reg-refs>}. The id of the referred index item is stored in the attribute \texttt{regest}. Finally, the parsed index is added to \texttt{sbr-regesten/sbr-regesten.xml}.

\subsubsection{Writing the Index into the Database}
\texttt{index\_to\_db.py} takes the \texttt{sbr-regesten.xml} as input and processes the index items. It creates an entry in the database, extracts the tags from the item and adds the information to the fields defined in the model (see Section~\ref{sec:data-model}).




\subsubsection{Future Work}

This section presents possible next steps for extending the XML schema for the index, extraction process and possible further uses. Depending on future demands, different extensions will have priority.  Section~\ref{sec:git} describes how to obtain a copy of the source code. After modifying the Sbr-Regesten schema or the extraction process, an XML Schema Validator, as the \href{http://corefiling.com/opensource/schemaValidate.html} {CoreFiling XML Schema Validator}, can be used to validate the XML output against the schema.

\paragraph{References to the Regests}
At the time of developing the index extraction, the regest part of the book was not yet extracted or written into the database. Once this is the case, the first expansion of the current code would be to solve the references to the regests. The references are already recognized and tagged with \texttt{reg-ref}. Each \texttt{<reg-ref>} is supposed to store the id of the regest it refers to in the attribute \texttt{regest}. This is not yet the case. The function \texttt{get\_regest\_ID} always returns the dummy id regest\_99999. We would recommend to reimplement the function \texttt{get\_regest\_ID} in 

\begin{verbatim}
sbr-regesten/extraction/index\_utils/index\_to\_xml.py
\end{verbatim}

The references can be solved by searching the database, as the regests are added to the database before \texttt{index\_to\_xml.py} is called. To include the references also in the database, the function \texttt{ment\_to\_db} in \texttt{sbr-regesten/extraction/index\_utils/index\_to\_db.py} has to be implemented.

\paragraph{Extracting Person Names}
The user can provide a list of forenames, which is used to extract the names of \texttt{person} items. The forenames have to be stored in \texttt{sbr-regesten/resources/forenames.txt}. During the extraction of the index it uses this list to recognize forenames and expands it at the same time. Newly amended names are only considered from the point on they were added. This could be overcome by proceeding similar to the solving of references to other index items (see Section~\ref{sec:index-refs}). In the extraction step persons would be recognized and parsed as such. At the same time the list of forenames would be augmented. In the post-processing step all extracted forenames could be used to parse the names. Additionally, a similar process could be conceivable for surnames, role names and generative names.

\paragraph{Quotes}
The HTML source provides information about which parts of the text are original text. Such sections are marked with italics (\texttt{<i>}). To mark original text the Sbr-Regesten schema introduces the element \texttt{quote}. This is mainly used in the regests. In the index, quotes are extracted from the description part of the bodies. The tag \texttt{<addNames>} implicitly encodes this information as they extract text in italics. Otherwise this information gets lost during the process of extraction. But we can imagine the usefulness of conserving information about original text also in other parts of the index, we propose to expand the schema to allow quotes.

\paragraph{Expand References to the Index}
References to other index entries are only found and solved if they appear in the header right after the mentionings. But such references can also appear in the bodies or in other parts of the headers, e.g. in location-headers before the district. The schema could be adapted to allow \texttt{reg-refs} there as well. They would have to be tagged by texttt{index\_to\_xml.py} and would then (automatically) be extracted by the existing the \texttt{parse\_siehe} function in \texttt{index\_xml\_postprocess}.

\paragraph{Recognize Persons in the Bodies}
Index item bodies often contain many persons which could be extracted using the \texttt{person} element defined in the Sbr-Regesten schema. The most prominent case, of course, are the bodies of families and persongroups. The current extraction process extracts persons at the outermost level of listing-bodies. But persons do also appear on deeper levels of listing-bodies or in concept bodies. These persons are currently parsed as \texttt{concepts}. The schema allows such extension, as it allows \texttt{persons} in the \texttt{related-concept} element.

\begin{verbatim}
  <xs:complexType name="related-concepts" mixed="true">
    <xs:choice maxOccurs="unbounded">
      <xs:element name="concept" type="concept" />
      <xs:element name="person" type="person" />
    </xs:choice>
  </xs:complexType>
\end{verbatim}

\paragraph{Semantic Network}
The regests and the index do not only provide information about entities, but also about the relations among them. This becomes evident especially in the case of persons. The index provides information such as \textit{married with} or \textit{son of}. This explicit information could be extracted to build networks of relations between persons or other entities. Also, we can imagine to extract such relations directly from the regests. The relations could build the basis for semantic queries and easy visualization of entity relations.